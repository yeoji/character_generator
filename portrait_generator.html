<!DOCTYPE html>
<html>

<body class="dark-mode">

<button style="position:absolute; right: 0;" onclick="toggleDarkMode()">Toggle dark mode</button>
<br/>

<details>
    <summary>Instructions:</summary>
    <p>1. Ensure portrait_generator.html is located in the same folder as Modern_UI</p>
    <p>2. Open portrait_generator.html</p>
    <p>3. Click Choose files to import Modern_UI assets</p>
    <p>4. Voila!</p>
</details>
<br/>
<label class="btn btn-primary">Select Portrait_Generator =>
    <input type="file" id="selectFiles" onchange="initializeCharacterAssetsFolder()" multiple webkitdirectory/>
</label>
<br/>
<br/>
<div id="selection"></div>
<div class="randomize" hidden>
    <button onclick="randomize()">Randomize</button>
    Skin: <input type="checkbox" name="Skin" checked/>
    Hair: <input type="checkbox" name="Hair" checked/>
    Eyes: <input type="checkbox" name="Eyes" checked/>
    Accs: <input type="checkbox" name="Accs" checked/>
</div>
<p>Right click to save</p>
<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const resolution = ["16x16", "32x32", "48x48"]


    var skins = [[], [], []];
    var hair = [[], [], []];
    var eyes = [[], [], []];
    var accessories = [[], [], []];

    var assetSizeMultiplier = [1, 1, 1]

    var selectedSize = 2;

    var selectedSkin = 1;
    var selectedHair = 1;
    var selectedEyes = 0;
    var selectedAccessories = 0;



    function initializeCharacterAssetsFolder() {
        var selectedFiles = Array.from(document.getElementById("selectFiles").files).map(element => ({name: element.name, path: element.webkitRelativePath}));
        for (var file of selectedFiles) {
            composeResource(file);
        }
        sort();
        initializeOptions();
        showRandomizeButton();
        draw();
    }

    //Remove all the select options & overload the functions to reload the options and canvas with the new options
    function removeAllChildNodes(parent) {

        while (parent.lastChild) {
            parent.removeChild(parent.firstChild);
        }

        // needs to be reset to avoid Array Out of Bounds
        resetSelectValues();
        initializeCharacterAssetsFolder();
    }

    function resetSelectValues(){

        skins = [[], [], []];
        hair = [[], [], []];
        eyes = [[], [], []];
        accessories = [[], [], []];


        selectedSkin = 1;
        selectedHair = 1;
        selectedAccessories = 0;
    }

    function composeResource(file) {
        var path = file.path.split("/");

        var size = path[1];

        switch (path[3]) {
            case `Hairstyles`:
            case `Hairstyles_${size}`:
                generateResource(hair, path, file);
                break;
            case `Skins`:
            case `Skins_${size}`:
                generateResource(skins, path, file);
                break;
            case `Eyes`:
            case `Eyes_${size}`:
                generateResource(eyes, path, file);
                break;
            case `Accessories`:
            case `Accessories_${size}`:
                generateResource(accessories, path, file);
                break;

        }
    }

    function sort() {
        skins.forEach(sortInnerArr);
        hair.forEach(sortInnerArr);
        eyes.forEach(sortInnerArr);
        accessories.forEach(sortInnerArr);

    }

    function sortInnerArr(arr) {
        arr.sort(function (a, b) {
            return a.name.localeCompare(b.name)
        });
        arr.splice(0, 0, {name: "n/a", path: ""});
    }

    function initializeOptions() {
        var div = document.getElementById("selection");

        div.appendChild(renderOption(resolution, "selectSize", selectedSize, function (e) {
            selectedSize = e.target.selectedIndex;
            draw();
        }));

        div.appendChild(renderOption(skins[selectedSize].map(x => x.name), "selectSkin", selectedSkin, function (e) {
            selectedSkin = e.target.selectedIndex;
            draw();
        }));

        div.appendChild(renderOption(hair[selectedSize].map(x => x.name), "selectHair", selectedHair, function (e) {
            selectedHair = e.target.selectedIndex;
            draw();
        }));

        div.appendChild(renderOption(eyes[selectedSize].map(x => x.name), "selectEyes", selectedEyes, function (e) {
            selectedEyes = e.target.selectedIndex;
            draw();
        }));

        div.appendChild(renderOption(accessories[selectedSize].map(x => x.name), "selectAccs", selectedAccessories, function (e) {
            selectedAccessories = e.target.selectedIndex;
            draw();
        }));
    }

    function renderOption(options, elementId, initialIndex, onChangeEvent) {
        var select = document.createElement("select");
        select.id = elementId;
        select.size = 15;
        select.addEventListener('change', onChangeEvent);
        for (var i = 0; i < options.length; i++) {
            var opt = options[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            el.selected = initialIndex == i;
            select.appendChild(el);
        }
        return select;
    }

    function showRandomizeButton() {
      document.querySelector('.randomize').hidden = false;
    }

    function randomize() {
        var enabledCheckboxes = document.querySelectorAll('.randomize input:checked');
        var categories = [...enabledCheckboxes].map(checkbox => checkbox.name);
        
        if(categories.includes('Skin')) {
            selectedSkin = selectRandomOption('Skin');
        }
        if(categories.includes('Hair')) {
            selectedHair = selectRandomOption('Hair', true);
        }
        if(categories.includes('Eyes')) {
            selectedHair = selectRandomOption('Eyes', true);
        }
        if(categories.includes('Accs')) {
            selectedAccessories = selectRandomOption('Accs', true);
        }
        draw();
    }

    function selectRandomOption(category, includeNA = false) {
        var select = document.getElementById(`select${category}`)
        if(!select) {
          return 0;
        }
        var items = select.getElementsByTagName('option');
        var index = Math.floor(Math.random() * (items.length - 1));
        if(!includeNA) {
            index += 1;
        }

        select.selectedIndex = index;
        return index;
    }

    function generateResource(arr, path, file) {
      switch (path[1]) {
        case "16x16":
            arr[0].push(file);
            break;
        case "32x32":
            arr[1].push(file);
            break;
        case "48x48":
            arr[2].push(file);
            break;
      }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        var imgPath = [];
        if (selectedSkin > 0)
            imgPath.push(skins[selectedSize][selectedSkin].path);
        if (selectedHair > 0)
            imgPath.push(hair[selectedSize][selectedHair].path);
        if (selectedEyes > 0)
            imgPath.push(eyes[selectedSize][selectedEyes].path);
        if (selectedAccessories > 0)
            imgPath.push(accessories[selectedSize][selectedAccessories].path);
        render(imgPath, 0)
    };

    function render(imagePath, index) {
        if (index >= imagePath.length)
            return;
        var img = new Image();
        img.src = imagePath[index];
        img.onload = function () {
            if (index == 0) {
                canvas.width = this.naturalWidth;
                canvas.height = this.naturalHeight;
                ctx.drawImage(this, 0, 0);
            } else {
                var width = (canvas.width / canvas.height) * this.naturalHeight;
                ctx.drawImage(this, 0, 0, this.naturalWidth * assetSizeMultiplier[selectedSize], this.naturalHeight * assetSizeMultiplier[selectedSize]);
            }
            render(imagePath, index + 1);
        }
    }

</script>

<script>

    function toggleDarkMode() {
        var element = document.body;
        element.classList.toggle("dark-mode");
    }
</script>
</body>
<style>
    body {
        padding: 25px;
        background-color: white;
        color: black;
        font-size: 25px;
    }

    .randomize {
        font-size: 18px;
    }

    .dark-mode {
        background-color: black;
        color: white;
    }
</style>

</html>